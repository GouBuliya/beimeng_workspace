# 自动化方案变更说明

**日期**：2025年10月30日  
**原因**：基于实际 SOP 操作手册调整技术方案

---

## 🔍 重大发现

### 原假设 ❌
- 直接操作 Temu 原生卖家后台
- 自定义搜索和编辑流程
- 灵活但不确定性高

### 实际情况 ✅
- **使用「妙手」采集箱工具**
- 标准化的批量编辑界面
- 认领机制（5条→20条→40条）
- 固定的 18 步编辑流程

---

## 📊 关键变更对比

| 项目 | 原方案 | 新方案（基于SOP） | 影响 |
|------|--------|-----------------|------|
| **目标平台** | Temu 原生后台 | 妙手采集箱工具 | 🟢 更稳定 |
| **采集数量** | 灵活（配置） | 固定 5 条 | 🟡 需调整 |
| **认领机制** | 无 | 每条认领4次=20条 | 🟢 新增功能 |
| **批量编辑** | 自定义流程 | 固定 18 步 | 🟢 更标准 |
| **发布次数** | 1 次 | 2 次（20×2=40） | 🟡 需调整 |
| **建议售价** | 成本 × 7.5 | 成本 × 10 | 🟡 需更新 |
| **供货价** | 成本 × 10 | 成本 × 7.5 | 🟡 需更新 |

---

## 🎯 数据流变更

### 原数据流
```
Excel → 任务数据 → Temu后台搜索 → 采集N条 → 编辑 → 发布1次
```

### 新数据流（基于SOP）
```
Excel → 任务数据 
    ↓
Temu前端店铺搜索 → 采集5条
    ↓
妙手采集箱首次编辑（5条）
    ├── AI标题生成
    ├── 类目验证
    ├── 图片替换
    └── 素材补充
    ↓
认领机制：5条 × 4次 = 20条
    ↓
批量二次编辑（20条）
    ├── 18个固定步骤
    ├── 固定值填充
    ├── 随机值生成
    └── 计算值填充
    ↓
选择店铺 + 设置供货价
    ↓
批量发布：20条 × 2次 = 40条
    ↓
结果验证：成功 50-100条
```

---

## 🔧 技术实现变更

### 1. 控制器模块重构

#### 原设计
```python
# 通用化，目标Temu原生后台
SearchController  # 搜索商品
EditController    # 编辑商品
PublishController # 发布商品
```

#### 新设计
```python
# 专门针对妙手工具
MiaoshouController
    ├── navigate_to_collection_box()  # 导航到采集箱
    ├── first_edit()                  # 首次编辑5条
    ├── claim_links()                 # 认领机制
    ├── verify_claims()               # 验证20条
    ├── batch_edit_18_steps()         # 批量编辑18步
    ├── select_shop()                 # 选择店铺
    ├── set_supply_price()            # 设置供货价
    └── batch_publish()               # 批量发布2次
```

### 2. 价格计算器更新

```python
# 原实现
class PriceCalculator:
    def calculate_suggested_price(cost):
        return cost * 7.5  # ❌ 旧倍率
        
    def calculate_supply_price(cost):
        return cost * 10   # ❌ 旧倍率

# 新实现（基于SOP）
class PriceCalculator:
    def calculate_suggested_price(cost):
        return cost * 10   # ✅ 步骤7.14
        
    def calculate_supply_price(cost):
        # 真实供货价 = cost × 2.5（最低）
        # 妙手供货价 = 真实 × 3
        return cost * 7.5  # ✅ 步骤9
```

### 3. 标题生成器增强

```python
# 新增功能
class TitleGenerator:
    def generate_with_model_suffix(self, titles: List[str]) -> List[str]:
        """生成标题并添加型号后缀（SOP要求）"""
        
        prompt = """
        提取上面5个商品标题中的高频热搜词，
        写5个新的中文标题，
        不要出现药品、急救等医疗相关的词汇
        符合欧美人的阅读习惯，
        符合TEMU/亚马逊平台规则，提高搜索流量
        """
        
        # AI生成
        new_titles = self.generate(titles, prompt)
        
        # 添加型号后缀（必须）
        return [f"{title} A{i:04d}型号" for i, title in enumerate(new_titles)]
```

### 4. 新增随机数据生成

```python
# src/data_processor/random_generator.py
class RandomDataGenerator:
    """生成符合SOP要求的随机数据"""
    
    @staticmethod
    def generate_weight() -> int:
        """重量：5000-9999G"""
        return random.randint(5000, 9999)
    
    @staticmethod
    def generate_dimensions() -> tuple[int, int, int]:
        """尺寸：50-99cm，长>宽>高"""
        length = random.randint(70, 99)
        width = random.randint(60, length-1)
        height = random.randint(50, width-1)
        return length, width, height
```

### 5. 固定值配置

```python
# config/miaoshou_config.py
class MiaoshouConfig:
    """妙手工具固定配置"""
    
    # 外包装
    PACKAGING_SHAPE = "长方体"
    PACKAGING_TYPE = "硬包装"
    
    # 产地
    ORIGIN = "浙江"
    
    # SKU分类
    SKU_CATEGORY = "组合装500件"
    
    # 认领次数
    CLAIM_COUNT = 4
    
    # 发布次数
    PUBLISH_COUNT = 2
```

---

## 📋 新增业务逻辑

### 1. 认领机制
```python
async def claim_links_workflow(self, links: List[str]):
    """
    新增：认领机制
    输入：5条链接
    输出：20条链接（5 × 4）
    """
    for link in links:
        for _ in range(4):  # 认领4次
            await self.click_claim_button(link)
            await asyncio.sleep(random.uniform(1, 2))
    
    # 验证结果
    total = await self.count_links_in_box()
    assert total == 20, f"认领失败：预期20条，实际{total}条"
```

### 2. 批量编辑18步
```python
async def batch_edit_18_steps(self, data: TaskProduct):
    """
    新增：固定的18步编辑流程
    """
    steps = [
        (1, self.edit_title, {"preview": True}),
        (2, self.edit_english_title, {"trigger_ai": True}),
        (3, self.edit_category_attrs, {"reference": data.category}),
        (4, self.skip_step, {}),
        (5, self.edit_packaging, {"shape": "长方体", "type": "硬包装"}),
        (6, self.edit_origin, {"location": "浙江"}),
        (7, self.skip_step, {}),
        (8, self.skip_step, {}),
        (9, self.edit_weight, {"value": self.generate_weight()}),
        (10, self.edit_dimensions, {"values": self.generate_dimensions()}),
        (11, self.edit_platform_sku, {"auto": True}),
        (12, self.edit_sku_category, {"value": "组合装500件"}),
        (13, self.skip_step, {}),
        (14, self.edit_suggested_price, {"value": data.suggested_price}),
        (15, self.skip_step, {}),
        (16, self.skip_step, {}),
        (17, self.skip_step, {}),
        (18, self.upload_manual, {"file": "data/templates/product_manual.pdf"}),
    ]
    
    for step_num, func, kwargs in steps:
        logger.info(f"执行第 {step_num} 步...")
        await func(**kwargs)
        await self.click_preview()
        await self.click_save()
        await asyncio.sleep(random.uniform(2, 3))
```

### 3. 双次发布
```python
async def batch_publish_workflow(self):
    """
    新增：双次发布机制
    20条 × 2次 = 40条
    """
    # 第1次发布
    await self.select_all_20_links()
    await self.click_batch_publish()
    await self.click_confirm()
    logger.info("第1次发布完成（20条）")
    
    await asyncio.sleep(5)
    
    # 第2次发布
    await self.click_batch_publish()
    await self.click_confirm()
    logger.info("第2次发布完成（20条）")
    
    # 预期结果：40条 → 成功50-100条
```

---

## ⚠️ 需要注意的变更

### 1. 配置文件更新

```diff
# .env.example
- PRICE_MULTIPLIER=7.5
+ PRICE_MULTIPLIER=10.0

- SUPPLY_PRICE_MULTIPLIER=10.0
+ SUPPLY_PRICE_MULTIPLIER=7.5

- COLLECT_COUNT=5
+ COLLECT_COUNT=5  # 保持不变，但含义明确为妙手采集数

+ CLAIM_COUNT=4  # 新增：认领次数
+ PUBLISH_COUNT=2  # 新增：发布次数
```

### 2. 数据模型调整

```python
# src/models/task.py
@dataclass
class TaskProduct:
    # 原有字段
    cost_price: float
    suggested_price: float  # cost × 10 ✅
    supply_price: float     # cost × 7.5 ✅
    
    # 新增字段
    weight: int            # 5000-9999G
    dimensions: Tuple[int, int, int]  # (长, 宽, 高)
    packaging_shape: str   # "长方体"
    packaging_type: str    # "硬包装"
    origin: str           # "浙江"
    sku_category: str     # "组合装500件"
    model_number: str     # "A0001型号"
```

### 3. 选择器配置

```json
// config/miaoshou_selectors.json
{
  "collection_box": {
    "url": "待确认",
    "search_input": "待使用codegen获取",
    "collect_button": "待获取",
    "link_item": "待获取"
  },
  "first_edit": {
    "title_input": "待获取",
    "category_select": "待获取",
    "image_upload": "待获取"
  },
  "claim": {
    "claim_button": "待获取",
    "verify_list": "待获取"
  },
  "batch_edit": {
    "select_all": "待获取",
    "batch_edit_button": "待获取",
    "step_inputs": {
      "1": "待获取",
      "2": "待获取"
      // ... 18个步骤
    },
    "preview_button": "待获取",
    "save_button": "待获取"
  },
  "publish": {
    "shop_select": "待获取",
    "supply_price_input": "待获取",
    "publish_button": "待获取",
    "confirm_button": "待获取"
  }
}
```

---

## 🎯 实施优先级调整

### 原计划
1. Week 1: 环境准备
2. Week 2: 搜索+编辑（通用化）
3. Week 3: 发布+测试

### 新计划（基于SOP）
1. Week 1: 环境准备 ✅ + 登录妙手
2. Week 2: 
   - 搜索采集（5条）
   - 首次编辑（图片辅助）
   - 认领机制（5→20）
   - 批量编辑（18步）
3. Week 3:
   - 发布流程（2次）
   - 集成测试
   - 优化完善

---

## 📊 预期效果对比

| 指标 | 原预期 | 新预期（基于SOP） |
|------|--------|-----------------|
| **单产品处理时间** | 5分钟 | 10-15分钟（含人工辅助） |
| **自动化程度** | 70% | 85% |
| **成功率** | >80% | >90%（流程标准化） |
| **人工介入点** | 验证码、异常 | +图片验证、类目复杂情况 |
| **批量处理** | 1次N条 | 5条→20条→40条（固定流程） |

---

## ✅ 下一步行动

1. **立即更新**：
   - [ ] 更新价格计算器倍率
   - [ ] 创建 MiaoshouController 模块
   - [ ] 创建随机数据生成器
   - [ ] 更新配置文件

2. **本周完成**：
   - [ ] 使用 codegen 获取妙手选择器
   - [ ] 实现认领机制
   - [ ] 实现批量编辑18步框架

3. **下周完成**：
   - [ ] 完善批量编辑逻辑
   - [ ] 实现双次发布
   - [ ] 端到端测试

---

## 📚 参考文档

- [SOP 操作手册](./guides/发布操作手册.md)
- [新方案 v2.0](./index-v2.md)
- [原方案 v1.0](./index.md)

---

**总结**：新方案更加贴合实际业务流程，虽然增加了一些固定步骤（认领、双次发布），但流程更标准化，预期成功率更高。

