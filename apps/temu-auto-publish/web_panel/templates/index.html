<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Temu å‘å¸ƒåŠ©æ‰‹ Â· Web Panel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Handsontable -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- è¡¨æ ¼ç¼–è¾‘å™¨æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/table-editor.css">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              primary: {
                50: '#eef2ff',
                100: '#e0e7ff',
                500: '#6366f1',
                600: '#4f46e5',
                700: '#4338ca',
              }
            }
          }
        }
      }
    </script>
    <style>
      /* Custom Scrollbar for Logs */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #1f2937;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #374151;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #4b5563;
      }
      
      /* Progress Steps Animation */
      .step-dot { transition: all 0.3s ease; }
      .step-line { transition: all 0.5s ease; }
      
      /* Status Pill Animations */
      @keyframes pulse-ring {
        0% { transform: scale(0.33); }
        80%, 100% { opacity: 0; }
      }
      .ring-container {
        position: relative;
      }
      .circle {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      .ringring {
        border: 3px solid #6366f1;
        border-radius: 30px;
        height: 20px;
        width: 20px;
        position: absolute;
        left: -6px;
        top: -6px;
        animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800 font-sans min-h-screen flex flex-col">
    
    <!-- Top Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center gap-4">
            <div class="flex-shrink-0 flex items-center gap-3">
              <div class="bg-indigo-600 p-1.5 rounded-lg">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
              </div>
              <span class="font-bold text-xl text-gray-900 tracking-tight">Temu å‘å¸ƒåŠ©æ‰‹</span>
              <span class="text-xs text-gray-400 font-normal ml-1">v{{ version }}</span>
            </div>
            <div class="hidden md:flex ml-10 space-x-8">
              <a href="#" class="border-indigo-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">æ§åˆ¶å°</a>
              <a href="/admin" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">ç”¨æˆ·ç®¡ç†</a>
              <a href="/downloads/sample-selection" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">ä¸‹è½½æ¨¡æ¿</a>
            </div>
          </div>
          <div class="flex items-center">
            <form method="post" action="/logout">
              <button type="submit" class="ml-4 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-md transition-colors">
                é€€å‡ºç™»å½•
              </button>
            </form>
          </div>
        </div>
      </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">å·¥ä½œå°</h1>
        <p class="mt-2 text-sm text-gray-600">ç®¡ç†æ‚¨çš„å‘å¸ƒä»»åŠ¡ï¼Œç›‘æ§å®æ—¶è¿›åº¦ä¸æ—¥å¿—ã€‚</p>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Left Column: Configuration -->
        <div class="lg:col-span-7 space-y-6">
          
          <!-- é€‰å“æ•°æ®è¾“å…¥ -->
          <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200">
            <div class="px-6 py-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
              <div class="flex items-center gap-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900">é€‰å“æ•°æ®</h3>
                <!-- è¾“å…¥æ¨¡å¼åˆ‡æ¢ -->
                <div class="input-mode-switcher">
                  <button type="button" id="mode-table" class="active">è¡¨æ ¼è¾“å…¥</button>
                  <button type="button" id="mode-csv">CSVä¸Šä¼ </button>
                </div>
              </div>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">Step 1</span>
            </div>

            <!-- è¡¨æ ¼è¾“å…¥æ¨¡å¼ -->
            <div id="table-input-mode" class="px-0 py-0">
              <!-- è¡¨æ ¼å·¥å…·æ  -->
              <div class="table-toolbar">
                <div class="toolbar-group">
                  <button type="button" id="btn-add-row" class="primary">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    æ·»åŠ è¡Œ
                  </button>
                  <button type="button" id="btn-duplicate-row">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    å¤åˆ¶è¡Œ
                  </button>
                  <button type="button" id="btn-delete-row" class="danger">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    åˆ é™¤
                  </button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                  <button type="button" id="btn-import-csv">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    å¯¼å…¥CSV
                  </button>
                  <button type="button" id="btn-export-csv">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    å¯¼å‡ºCSV
                  </button>
                  <button type="button" id="btn-clear-table" class="danger">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    æ¸…ç©º
                  </button>
                </div>
                <span class="row-count" id="table-row-count">å·²è¾“å…¥ 0 è¡Œ</span>
              </div>

              <!-- è¡¨æ ¼å®¹å™¨ -->
              <div class="table-editor-container">
                <div class="table-editor-wrapper" id="selection-table"></div>
              </div>

              <!-- çŠ¶æ€æ  -->
              <div class="px-4 py-2 bg-gray-50 border-t border-gray-200 flex items-center justify-between text-xs text-gray-500">
                <span id="table-draft-status"></span>
                <span>æç¤º: ç‚¹å‡»å›¾ç‰‡å•å…ƒæ ¼å¯ç¼–è¾‘å›¾ç‰‡ï¼Œæ”¯æŒä¸Šä¼ å’ŒURLæ·»åŠ </span>
              </div>
            </div>

            <!-- CSVä¸Šä¼ æ¨¡å¼ (éšè—) -->
            <div id="csv-input-mode" class="px-6 py-5 hidden">
              <div class="rounded-lg bg-blue-50 p-4 mb-4">
                <div class="flex">
                  <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <div class="ml-3 flex-1 md:flex md:justify-between">
                    <p class="text-sm text-blue-700">CSV/Excel é«˜çº§ä¸Šä¼ æ¨¡å¼ï¼Œé€‚åˆæ‰¹é‡å¯¼å…¥å¤§é‡æ•°æ®ã€‚</p>
                    <p class="mt-3 text-sm md:mt-0 md:ml-6">
                      <a href="/downloads/sample-selection" class="whitespace-nowrap font-medium text-blue-700 hover:text-blue-600">ä¸‹è½½ç¤ºä¾‹æ–‡ä»¶ &rarr;</a>
                    </p>
                  </div>
                </div>
              </div>

              <!-- CSV æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
              <div class="file-upload-area mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-indigo-400 transition-colors cursor-pointer relative bg-gray-50 hover:bg-white" id="csv-upload-area">
                <div class="upload-placeholder space-y-1 text-center pointer-events-none">
                  <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  <div class="flex text-sm text-gray-600 justify-center">
                    <span class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500">
                      <span>ç‚¹å‡»ä¸Šä¼  CSV/Excel æ–‡ä»¶</span>
                    </span>
                  </div>
                  <p class="text-xs text-gray-500">æ”¯æŒ .csv, .xlsx, .xls æ ¼å¼</p>
                </div>
                <div class="file-selected hidden space-y-2 text-center pointer-events-none">
                  <svg class="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <p class="csv-file-name text-sm font-medium text-gray-900 truncate max-w-xs"></p>
                  <p class="csv-file-size text-xs text-gray-500"></p>
                  <p class="text-xs text-indigo-600">ç‚¹å‡»æ›´æ¢æ–‡ä»¶</p>
                </div>
                <input type="file" id="csv-file-input" accept=".csv,.xlsx,.xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
              </div>
            </div>
          </div>

          <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ç”¨äºå¯¼å…¥CSV -->
          <input type="file" id="import-csv-input" accept=".csv" class="hidden" />

          <!-- Run Configuration Form -->
          <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200">
            <div class="px-6 py-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
              <h3 class="text-lg font-medium leading-6 text-gray-900">è¿è¡Œé…ç½®</h3>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">Step 2</span>
            </div>
            <div class="px-6 py-6">
              <form id="control-form" enctype="multipart/form-data" class="space-y-6">
                {% for field in fields %}
                  {% if field.kind == "file" %}
                  <!-- é€‰å“è¡¨æ–‡ä»¶å­—æ®µä»…åœ¨ CSV æ¨¡å¼ä¸‹æ˜¾ç¤º -->
                  <div class="{% if field.name == 'selection_file' %}selection-file-field hidden{% endif %}">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      {{ field.label }}
                      {% if field.required %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    <div class="file-upload-area mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-indigo-400 transition-colors cursor-pointer relative bg-gray-50 hover:bg-white" data-field="{{ field.name }}">
                      <!-- é»˜è®¤ä¸Šä¼ æç¤º -->
                      <div class="upload-placeholder space-y-1 text-center pointer-events-none">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                          <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <div class="flex text-sm text-gray-600 justify-center">
                          <span class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                            <span>ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</span>
                          </span>
                        </div>
                        <p class="text-xs text-gray-500">{{ field.help_text }}</p>
                      </div>
                      <!-- å·²é€‰æ‹©æ–‡ä»¶æ˜¾ç¤º -->
                      <div class="file-selected hidden space-y-2 text-center pointer-events-none">
                        <svg class="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="file-name text-sm font-medium text-gray-900 truncate max-w-xs"></p>
                        <p class="file-size text-xs text-gray-500"></p>
                        <p class="text-xs text-indigo-600">ç‚¹å‡»æ›´æ¢æ–‡ä»¶</p>
                      </div>
                      <input
                        type="file"
                        name="{{ field.name }}"
                        class="file-input absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                        {% if field.accept %}accept="{{ field.accept }}"{% endif %}
                        {% if field.required and field.name != 'selection_file' %}required{% endif %}
                      />
                    </div>
                  </div>

                  {% elif field.kind == "path" %}
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      {{ field.label }}
                      {% if field.required %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                      <input
                        type="text"
                        name="{{ field.name }}"
                        class="focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-lg p-2.5 border"
                        placeholder="{{ field.placeholder }}"
                        value="{{ field.default or '' }}"
                        {% if field.required %}required{% endif %}
                      />
                    </div>
                    <p class="mt-1 text-xs text-gray-500">{{ field.help_text }}</p>
                  </div>

                  {% elif field.kind == "choice" %}
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ field.label }}</label>
                    <select
                      name="{{ field.name }}"
                      class="mt-1 block w-full pl-3 pr-10 py-2.5 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg border"
                    >
                      {% for value, label in field.options %}
                      <option value="{{ value }}" {% if field.default == value %}selected{% endif %}>
                        {{ label }}
                      </option>
                      {% endfor %}
                    </select>
                    <p class="mt-1 text-xs text-gray-500">{{ field.help_text }}</p>
                  </div>

                  {% else %}
                  <div class="relative flex items-start py-2">
                    <div class="flex items-center h-5">
                      <input
                        type="checkbox"
                        name="{{ field.name }}"
                        class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
                        {% if field.default %}checked{% endif %}
                      />
                    </div>
                    <div class="ml-3 text-sm">
                      <label class="font-medium text-gray-700">{{ field.label }}</label>
                      <p class="text-gray-500">{{ field.help_text }}</p>
                    </div>
                  </div>
                  {% endif %}
                {% endfor %}

                <div class="pt-4 flex items-center gap-4">
                  <button
                    type="submit"
                    id="run-btn"
                    class="flex-1 flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed group"
                  >
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden group-aria-[busy=true]:block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    å¼€å§‹æ‰§è¡Œä»»åŠ¡
                  </button>

                  <button
                    type="button"
                    id="health-btn"
                    class="flex-none px-4 py-3 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors"
                  >
                    ç¯å¢ƒè‡ªæ£€
                  </button>

                  <button
                    type="button"
                    id="clear-cookies-btn"
                    class="flex-none px-4 py-3 border border-orange-300 shadow-sm text-sm font-medium rounded-lg text-orange-700 bg-orange-50 hover:bg-orange-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors"
                    title="æ¸…é™¤æµè§ˆå™¨ç™»å½•çŠ¶æ€ï¼Œä¸‹æ¬¡è¿è¡Œå°†è‡ªåŠ¨é‡æ–°ç™»å½•"
                  >
                    æ¸…é™¤ Cookie
                  </button>
                </div>
                
                <div id="form-error" class="hidden rounded-md bg-red-50 p-4">
                  <div class="flex">
                    <div class="flex-shrink-0">
                      <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                      </svg>
                    </div>
                    <div class="ml-3">
                      <h3 class="text-sm font-medium text-red-800">æäº¤é”™è¯¯</h3>
                      <div class="mt-2 text-sm text-red-700">
                        <p id="form-error-text"></p>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- System Settings Collapsible -->
          <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200">
            <details class="group">
              <summary class="flex justify-between items-center font-medium cursor-pointer list-none px-6 py-5 bg-gray-50 hover:bg-gray-100 transition-colors">
                <span class="flex items-center gap-2 text-gray-900">
                  <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  ç³»ç»Ÿè®¾ç½® (.env)
                </span>
                <span class="transition group-open:rotate-180">
                  <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                </span>
              </summary>
              <div class="px-6 py-6 border-t border-gray-100">
                <p class="text-sm text-gray-500 mb-4">å¡«å†™å¿…è¦çš„è´¦å·ä¸ API Keyï¼Œä¿å­˜åç«‹å³ç”Ÿæ•ˆã€‚</p>
                <form id="env-form" class="space-y-4">
                  {% for field in env_fields %}
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      {{ field.label }}
                      {% if field.required %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    <input
                      type="{% if field.secret %}password{% else %}text{% endif %}"
                      name="{{ field.key }}"
                      class="focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-lg p-2.5 border"
                      placeholder="{{ field.placeholder or '' }}"
                      {% if field.required %}required{% endif %}
                    />
                    <p class="mt-1 text-xs text-gray-500">{{ field.help_text }}</p>
                  </div>
                  {% endfor %}
                  <div class="flex items-center gap-4 pt-2">
                    <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                      ä¿å­˜è®¾ç½®
                    </button>
                    <span id="env-save-status" class="text-sm font-medium transition-opacity opacity-0"></span>
                  </div>
                </form>
              </div>
            </details>
          </div>
        </div>

        <!-- Right Column: Monitoring -->
        <div class="lg:col-span-5 space-y-6">
          
          <!-- Status Card -->
          <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200">
            <div class="px-6 py-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
              <h3 class="text-lg font-medium leading-6 text-gray-900">å®æ—¶ç›‘æ§</h3>
              <div class="flex items-center gap-2">
                <span id="status-pill-container" class="relative flex h-3 w-3">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-gray-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-3 w-3 bg-gray-500"></span>
                </span>
                <span id="status-pill" class="text-sm font-medium text-gray-500">é—²ç½®</span>
              </div>
            </div>
            <div class="px-6 py-6">
              
              <!-- Progress Track -->
              <div class="relative py-4">
                <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-100">
                  <div id="progress-bar-fill" style="width: 0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-indigo-500 transition-all duration-500"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500">
                  <div class="text-center w-1/4 transition-colors duration-300" id="step-label-1">å‡†å¤‡</div>
                  <div class="text-center w-1/4 transition-colors duration-300" id="step-label-2">è¿è¡Œ</div>
                  <div class="text-center w-1/4 transition-colors duration-300" id="step-label-3">å¤„ç†</div>
                  <div class="text-center w-1/4 transition-colors duration-300" id="step-label-4">å®Œæˆ</div>
                </div>
                
                <!-- Hidden original steps for JS compatibility -->
                <div class="hidden">
                  <div id="step-1"></div>
                  <div id="step-2"></div>
                  <div id="step-3"></div>
                  <div id="step-4"></div>
                </div>
              </div>

              <div class="mt-6 space-y-4">
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                  <p class="text-sm text-gray-500 mb-1">å½“å‰çŠ¶æ€</p>
                  <p id="status-message" class="text-base font-medium text-gray-900">ç­‰å¾…å¼€å§‹ ...</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                    <p class="text-xs text-gray-500 mb-1">Workflow ID</p>
                    <p id="workflow-id" class="text-sm font-mono font-medium text-gray-900 truncate">-</p>
                  </div>
                  <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                    <p class="text-xs text-gray-500 mb-1">æœ€è¿‘é”™è¯¯</p>
                    <p id="status-error" class="text-sm font-medium text-red-600 truncate">-</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Logs Card -->
          <div class="bg-[#1e1e1e] overflow-hidden shadow-lg rounded-xl border border-gray-800 flex flex-col h-[500px]">
            <div class="px-4 py-3 border-b border-gray-800 bg-[#252526] flex justify-between items-center">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="text-sm font-mono text-gray-300">Terminal Output</span>
              </div>
              <div class="flex gap-1.5">
                <div class="w-2.5 h-2.5 rounded-full bg-red-500"></div>
                <div class="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
                <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
              </div>
            </div>
            <div class="flex-grow p-4 overflow-y-auto custom-scrollbar font-mono text-xs leading-relaxed" id="log-box">
              <div class="text-gray-500 mb-2">System initialized. Waiting for commands...</div>
            </div>
          </div>
          
          <!-- Help/FAQ -->
           <div class="bg-blue-50 border border-blue-100 rounded-xl p-4">
            <h4 class="text-sm font-bold text-blue-900 mb-2">ğŸ’¡ å¸¸è§æç¤º</h4>
             <ul class="text-xs text-blue-800 space-y-1.5 list-disc list-inside">
              <li>â€œæ˜¾ç¤ºçª—å£â€å¯å¯ç”¨æœ‰å¤´æ¨¡å¼è¿›è¡Œäººå·¥è§‚å¯Ÿã€‚</li>
              <li>å‹¾é€‰â€œä»…æ‰§è¡Œè®¤é¢†â€å¯å¿«é€ŸéªŒè¯è´¦å·æœ‰æ•ˆæ€§ã€‚</li>
              <li>è‹¥é‡åˆ°æœªçŸ¥é”™è¯¯ï¼Œè¯·æˆªå›¾æ—¥å¿—è”ç³»æŠ€æœ¯æ”¯æŒã€‚</li>
            </ul>
           </div>

        </div>
      </div>
    </main>

    <footer class="bg-white border-t border-gray-200 mt-auto">
      <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <p class="text-center text-sm text-gray-500">
          &copy; 2024 Temu Auto Publish v{{ version }}. All rights reserved.
        </p>
      </div>
    </footer>

    <!-- Scripts (Preserving Logic) -->
    <script>
      const form = document.getElementById("control-form");
      const runBtn = document.getElementById("run-btn");
      const healthBtn = document.getElementById("health-btn");
      const clearCookiesBtn = document.getElementById("clear-cookies-btn");
      const statusPill = document.getElementById("status-pill");
      const statusPillContainer = document.getElementById("status-pill-container");
      const statusMessage = document.getElementById("status-message");
      const statusError = document.getElementById("status-error");
      const workflowId = document.getElementById("workflow-id");
      const logBox = document.getElementById("log-box");
      const formError = document.getElementById("form-error");
      const formErrorText = document.getElementById("form-error-text"); // New Text Element
      
      // Original Step Elements (Hidden)
      const steps = [
        document.getElementById("step-1"),
        document.getElementById("step-2"),
        document.getElementById("step-3"),
        document.getElementById("step-4"),
      ];
      // New Visual Step Elements
      const stepLabels = [
        document.getElementById("step-label-1"),
        document.getElementById("step-label-2"),
        document.getElementById("step-label-3"),
        document.getElementById("step-label-4"),
      ];
      const progressBarFill = document.getElementById("progress-bar-fill");

      const envForm = document.getElementById("env-form");
      const envSaveStatus = document.getElementById("env-save-status");
      let envSettingsCache = [];

      let logCursor = -1;

      // æ–‡ä»¶ä¸Šä¼ çŠ¶æ€å¤„ç†
      function initFileUploadAreas() {
        document.querySelectorAll('.file-upload-area').forEach(area => {
          const input = area.querySelector('.file-input');
          const placeholder = area.querySelector('.upload-placeholder');
          const selected = area.querySelector('.file-selected');
          const fileName = area.querySelector('.file-name');
          const fileSize = area.querySelector('.file-size');

          if (!input) return; // è·³è¿‡æ²¡æœ‰ .file-input çš„åŒºåŸŸ
          input.addEventListener('change', function() {
            if (this.files && this.files[0]) {
              const file = this.files[0];
              // æ˜¾ç¤ºå·²é€‰æ‹©çŠ¶æ€
              placeholder.classList.add('hidden');
              selected.classList.remove('hidden');
              fileName.textContent = file.name;
              fileSize.textContent = formatFileSize(file.size);
              // æ”¹å˜è¾¹æ¡†é¢œè‰²
              area.classList.remove('border-gray-300', 'bg-gray-50');
              area.classList.add('border-green-400', 'bg-green-50');
            } else {
              // é‡ç½®ä¸ºé»˜è®¤çŠ¶æ€
              placeholder.classList.remove('hidden');
              selected.classList.add('hidden');
              area.classList.add('border-gray-300', 'bg-gray-50');
              area.classList.remove('border-green-400', 'bg-green-50');
            }
          });
        });
      }
      
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
      
      // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
      initFileUploadAreas();

      // æ³¨æ„: è¡¨å•æäº¤å¤„ç†å·²ç§»è‡³è¡¨æ ¼ç¼–è¾‘å™¨è„šæœ¬å—ä¸­çš„ bindFormSubmit() å‡½æ•°

      if (healthBtn) healthBtn.addEventListener("click", async () => {
        const originalText = healthBtn.textContent;
        healthBtn.textContent = "æ£€æŸ¥ä¸­...";
        healthBtn.disabled = true;

        try {
          const response = await fetch("/health");
          const payload = await response.json();
          statusMessage.textContent =
            payload.ok === false
              ? "ç¯å¢ƒå¼‚å¸¸, è¯·æ£€æŸ¥ä¾èµ–åé‡è¯•"
              : `ç¯å¢ƒæ­£å¸¸ Â· ä½¿ç”¨è·¯å¾„ ${payload.selection_dir}`;

          // Flash success
          healthBtn.classList.add("bg-green-50", "text-green-700", "border-green-300");
          setTimeout(() => {
             healthBtn.classList.remove("bg-green-50", "text-green-700", "border-green-300");
          }, 2000);

        } catch (error) {
          statusMessage.textContent = "è‡ªæ£€å¤±è´¥, è¯·ç¨åå†è¯•";
        } finally {
          healthBtn.textContent = originalText;
          healthBtn.disabled = false;
        }
      });

      if (clearCookiesBtn) clearCookiesBtn.addEventListener("click", async () => {
        if (!confirm("ç¡®å®šè¦æ¸…é™¤æµè§ˆå™¨ Cookie å—ï¼Ÿ\n\næ¸…é™¤åé¦–æ¬¡è¿è¡Œæ—¶ï¼Œè„šæœ¬å°†è‡ªåŠ¨ä½¿ç”¨ç³»ç»Ÿè®¾ç½®ä¸­çš„è´¦å·å¯†ç é‡æ–°ç™»å½•ã€‚")) {
          return;
        }

        const originalText = clearCookiesBtn.textContent;
        clearCookiesBtn.textContent = "æ¸…é™¤ä¸­...";
        clearCookiesBtn.disabled = true;

        try {
          const response = await fetch("/api/clear-cookies", {
            method: "POST",
          });
          const payload = await response.json();

          if (!response.ok) {
            throw new Error(payload.detail || "æ¸…é™¤å¤±è´¥");
          }

          statusMessage.textContent = payload.message || "Cookie å·²æ¸…é™¤";

          // Flash success
          clearCookiesBtn.classList.remove("border-orange-300", "text-orange-700", "bg-orange-50");
          clearCookiesBtn.classList.add("border-green-300", "text-green-700", "bg-green-50");
          setTimeout(() => {
            clearCookiesBtn.classList.add("border-orange-300", "text-orange-700", "bg-orange-50");
            clearCookiesBtn.classList.remove("border-green-300", "text-green-700", "bg-green-50");
          }, 2000);

        } catch (error) {
          statusMessage.textContent = error.message || "æ¸…é™¤ Cookie å¤±è´¥";
          // Flash error
          clearCookiesBtn.classList.remove("border-orange-300", "text-orange-700", "bg-orange-50");
          clearCookiesBtn.classList.add("border-red-300", "text-red-700", "bg-red-50");
          setTimeout(() => {
            clearCookiesBtn.classList.add("border-orange-300", "text-orange-700", "bg-orange-50");
            clearCookiesBtn.classList.remove("border-red-300", "text-red-700", "bg-red-50");
          }, 2000);
        } finally {
          clearCookiesBtn.textContent = originalText;
          clearCookiesBtn.disabled = false;
        }
      });

      function updatePill(state) {
        // Reset styles
        statusPill.className = "text-sm font-medium";
        const dot = statusPillContainer.querySelector(".animate-ping");
        const dotStatic = statusPillContainer.querySelector(".relative");
        
        if (state === "running") {
          statusPill.classList.add("text-indigo-600");
          statusPill.textContent = "è¿è¡Œä¸­";
          dot.className = "animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75";
          dotStatic.className = "relative inline-flex rounded-full h-3 w-3 bg-indigo-500";
        } else if (state === "success") {
          statusPill.classList.add("text-green-600");
          statusPill.textContent = "å·²å®Œæˆ";
          dot.className = "hidden";
          dotStatic.className = "relative inline-flex rounded-full h-3 w-3 bg-green-500";
        } else if (state === "failed") {
          statusPill.classList.add("text-red-600");
          statusPill.textContent = "å¤±è´¥";
          dot.className = "hidden";
          dotStatic.className = "relative inline-flex rounded-full h-3 w-3 bg-red-500";
        } else {
          statusPill.classList.add("text-gray-500");
          statusPill.textContent = "é—²ç½®";
          dot.className = "hidden";
          dotStatic.className = "relative inline-flex rounded-full h-3 w-3 bg-gray-500";
        }
      }

      function updateProgress(state) {
        // Map states to progress bar width and label colors
        let progress = 0;
        let activeIndex = 0;
        
        if (state === "running") {
          progress = 50; // Step 2/3 roughly
          activeIndex = 1;
        } else if (state === "success") {
          progress = 100;
          activeIndex = 3;
        } else if (state === "failed") {
          progress = 100; // Complete but red
          activeIndex = 3; 
        } else {
          progress = 0;
          activeIndex = 0;
        }

        progressBarFill.style.width = `${progress}%`;
        
        // Color logic for progress bar
        if (state === "failed") {
            progressBarFill.classList.remove("bg-indigo-500", "bg-green-500");
            progressBarFill.classList.add("bg-red-500");
        } else if (state === "success") {
            progressBarFill.classList.remove("bg-indigo-500", "bg-red-500");
            progressBarFill.classList.add("bg-green-500");
        } else {
            progressBarFill.classList.remove("bg-green-500", "bg-red-500");
            progressBarFill.classList.add("bg-indigo-500");
        }

        // Update Labels
        stepLabels.forEach((label, index) => {
            if (index <= activeIndex) {
                label.classList.add("text-indigo-600", "font-medium");
                label.classList.remove("text-gray-500");
            } else {
                label.classList.remove("text-indigo-600", "font-medium");
                label.classList.add("text-gray-500");
            }
        });
      }

      async function refreshStatus() {
        try {
            const response = await fetch("/api/status");
            const payload = await response.json();
            updatePill(payload.state);
            updateProgress(payload.state);
            statusMessage.textContent = payload.message;
            workflowId.textContent = payload.workflow_id || "-";

            // å¤„ç† CSV éªŒè¯é”™è¯¯çš„è¯¦ç»†å±•ç¤º
            if (payload.csv_validation_errors && payload.csv_validation_errors.length > 0) {
                displayCSVValidationErrors(payload.csv_validation_errors, payload.last_error);
            } else {
                statusError.innerHTML = payload.last_error || "æš‚æ— ";
                statusError.classList.remove("cursor-pointer", "hover:text-red-700");
                statusError.onclick = null;
            }
        } catch(e) {
            console.error("Status refresh failed", e);
        }
      }

      function displayCSVValidationErrors(errors, summary) {
        // ç®€çŸ­æ˜¾ç¤ºåœ¨çŠ¶æ€åŒºåŸŸï¼Œç‚¹å‡»å¯å±•å¼€è¯¦æƒ…
        const errorCount = errors.length;
        statusError.innerHTML = `<span class="underline">CSV æ ¼å¼é”™è¯¯ (${errorCount}å¤„)</span> <span class="text-xs">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</span>`;
        statusError.classList.add("cursor-pointer", "hover:text-red-700");
        statusError.onclick = () => showCSVErrorModal(errors, summary);
      }

      function showCSVErrorModal(errors, summary) {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement("div");
        modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        modal.id = "csv-error-modal";

        let errorListHtml = "";
        errors.forEach((err, idx) => {
            const colInfo = err.column_name ? ` [${err.column_name}]` : "";
            const contextHtml = err.context ? `<pre class="text-xs text-gray-500 mt-1 bg-gray-100 p-2 rounded overflow-x-auto">${escapeHtml(err.context)}</pre>` : "";
            errorListHtml += `
                <div class="pl-3 border-l-2 border-red-300 py-2">
                    <div class="flex items-center gap-2">
                        <span class="bg-red-100 text-red-700 text-xs px-2 py-0.5 rounded">${err.error_type}</span>
                        <span class="font-medium">ç¬¬ ${err.row} è¡Œ${colInfo}</span>
                    </div>
                    <p class="text-sm text-gray-700 mt-1">${escapeHtml(err.message)}</p>
                    ${contextHtml}
                </div>
            `;
        });

        modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-red-600">CSV æ ¼å¼éªŒè¯å¤±è´¥</h3>
                    <button onclick="closeCSVErrorModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto flex-grow">
                    <p class="text-sm text-gray-600 mb-4">è¯·æ£€æŸ¥ä»¥ä¸‹æ ¼å¼é—®é¢˜å¹¶ä¿®æ­£åé‡æ–°ä¸Šä¼ :</p>
                    <div class="space-y-3">
                        ${errorListHtml}
                    </div>
                </div>
                <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
                    <button onclick="closeCSVErrorModal()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition">
                        æˆ‘çŸ¥é“äº†
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        modal.onclick = (e) => {
            if (e.target === modal) closeCSVErrorModal();
        };
      }

      function closeCSVErrorModal() {
        const modal = document.getElementById("csv-error-modal");
        if (modal) modal.remove();
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      async function refreshLogs() {
        try {
            const response = await fetch(`/api/logs?after=${logCursor}`);
            const payload = await response.json();
            if (Array.isArray(payload) && payload.length > 0) {
            payload.forEach((log) => {
                // Colorize logs based on level
                let colorClass = "text-gray-300";
                if (log.level === "ERROR") colorClass = "text-red-400";
                else if (log.level === "WARNING") colorClass = "text-yellow-400";
                else if (log.level === "INFO") colorClass = "text-blue-300";
                else if (log.level === "SUCCESS") colorClass = "text-green-400";

                const time = new Date(log.timestamp * 1000).toLocaleTimeString();
                const lineHtml = `<div class="font-mono text-xs hover:bg-[#2a2a2c] py-0.5 px-1 rounded transition-colors">
                                    <span class="text-gray-500">[${time}]</span>
                                    <span class="${colorClass} font-bold">[${log.level}]</span>
                                    <span class="text-gray-300">${log.message}</span>
                                </div>`;
                logBox.insertAdjacentHTML('beforeend', lineHtml);
                logCursor = log.index;
            });
            logBox.scrollTop = logBox.scrollHeight;
            }
        } catch(e) {
            console.error("Log refresh failed", e);
        }
      }

      setInterval(refreshStatus, 2500);
      setInterval(refreshLogs, 2500);
      refreshStatus();
      if (envForm) {
        loadEnvSettings();
        envForm.addEventListener("submit", submitEnvForm);
      }

      async function loadEnvSettings() {
        try {
          const response = await fetch("/api/env-settings");
          if (!response.ok) {
            throw new Error();
          }
          const payload = await response.json();
          envSettingsCache = payload;
          payload.forEach((field) => {
            const input = envForm.querySelector(`[name="${field.key}"]`);
            if (input) {
              input.value = field.value ?? "";
            }
          });
        } catch (error) {
          envSaveStatus.textContent = "æ— æ³•åŠ è½½è®¾ç½®";
          envSaveStatus.className = "text-sm font-medium text-red-600 opacity-100";
        }
      }

      async function submitEnvForm(event) {
        event.preventDefault();
        envSaveStatus.textContent = "ä¿å­˜ä¸­...";
        envSaveStatus.className = "text-sm font-medium text-gray-500 opacity-100";
        
        const formData = new FormData(envForm);
        const entries = {};
        formData.forEach((value, key) => {
          entries[key] = value.toString();
        });
        try {
          const response = await fetch("/api/env-settings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ entries }),
          });
          const payload = await response.json();
          if (!response.ok) {
            throw new Error(payload.detail || "ä¿å­˜å¤±è´¥");
          }
          envSaveStatus.textContent = "ä¿å­˜æˆåŠŸ";
          envSaveStatus.className = "text-sm font-medium text-green-600 opacity-100";
          setTimeout(() => { envSaveStatus.classList.add("opacity-0"); }, 3000);
          
          await loadEnvSettings();
        } catch (error) {
          envSaveStatus.textContent = error.message || "ä¿å­˜å¤±è´¥";
          envSaveStatus.className = "text-sm font-medium text-red-600 opacity-100";
        }
      }

      function usesDefaultMiaoshouAccount() {
        if (!envSettingsCache.length) {
          return false;
        }
        const targetKeys = ["MIAOSHOU_USERNAME", "MIAOSHOU_PASSWORD"];
        return targetKeys.some((key) => {
          const entry = envSettingsCache.find((field) => field.key === key);
          if (!entry) {
            return false;
          }
          const value = (entry.value || "").trim().toLowerCase();
          return value === "tester";
        });
      }
    </script>

    <!-- è¡¨æ ¼ç¼–è¾‘å™¨è„šæœ¬ -->
    <script src="/static/js/table-editor.js"></script>
    <script src="/static/js/spec-group-editor.js"></script>
    <script src="/static/js/image-cell-editor.js"></script>
    <script src="/static/js/csv-utils.js"></script>

    <script>
      // ========================================
      // è¡¨æ ¼ç¼–è¾‘å™¨åˆå§‹åŒ–
      // ========================================
      // æš´éœ²åˆ°å…¨å±€ä»¥ä¾¿è°ƒè¯•
      window.tableEditor = null;
      let currentInputMode = 'table'; // 'table' or 'csv'

      // åˆå§‹åŒ–è¡¨æ ¼ç¼–è¾‘å™¨
      function initTableEditor() {
        if (window.tableEditor) return; // é˜²æ­¢é‡å¤åˆå§‹åŒ–
        const container = document.getElementById('selection-table');
        if (!container) {
          console.error('è¡¨æ ¼å®¹å™¨æœªæ‰¾åˆ°');
          return;
        }
        window.tableEditor = new TableEditor('selection-table', {
          onDataChange: () => {
            // æ•°æ®å˜åŒ–æ—¶çš„å›è°ƒ
          }
        });
        window.tableEditor.init();
      }

      // è¾“å…¥æ¨¡å¼åˆ‡æ¢
      function switchInputMode(mode) {
        currentInputMode = mode;
        const modeTableBtn = document.getElementById('mode-table');
        const modeCsvBtn = document.getElementById('mode-csv');
        const tableInputMode = document.getElementById('table-input-mode');
        const csvInputMode = document.getElementById('csv-input-mode');
        const selectionFileField = document.querySelector('.selection-file-field');

        if (mode === 'table') {
          if (modeTableBtn) modeTableBtn.classList.add('active');
          if (modeCsvBtn) modeCsvBtn.classList.remove('active');
          if (tableInputMode) tableInputMode.classList.remove('hidden');
          if (csvInputMode) csvInputMode.classList.add('hidden');
          if (selectionFileField) selectionFileField.classList.add('hidden');
        } else {
          if (modeTableBtn) modeTableBtn.classList.remove('active');
          if (modeCsvBtn) modeCsvBtn.classList.add('active');
          if (tableInputMode) tableInputMode.classList.add('hidden');
          if (csvInputMode) csvInputMode.classList.remove('hidden');
          if (selectionFileField) selectionFileField.classList.remove('hidden');
        }
      }

      // åˆå§‹åŒ–è¡¨æ ¼ç¼–è¾‘å™¨å’Œç»‘å®šäº‹ä»¶
      function initTableEditorAndBindings() {
        // åˆå§‹åŒ–è¡¨æ ¼
        initTableEditor();

        // ç»‘å®šæ¨¡å¼åˆ‡æ¢æŒ‰é’®
        const modeTableBtn = document.getElementById('mode-table');
        const modeCsvBtn = document.getElementById('mode-csv');
        if (modeTableBtn) modeTableBtn.addEventListener('click', () => switchInputMode('table'));
        if (modeCsvBtn) modeCsvBtn.addEventListener('click', () => switchInputMode('csv'));

        // ç»‘å®šå·¥å…·æ æŒ‰é’®
        const btnAddRow = document.getElementById('btn-add-row');
        const btnDuplicateRow = document.getElementById('btn-duplicate-row');
        const btnDeleteRow = document.getElementById('btn-delete-row');
        const btnClearTable = document.getElementById('btn-clear-table');
        const btnImportCsv = document.getElementById('btn-import-csv');
        const btnExportCsv = document.getElementById('btn-export-csv');
        const importCsvInput = document.getElementById('import-csv-input');

        if (btnAddRow) btnAddRow.addEventListener('click', () => {
          if (window.tableEditor) window.tableEditor.addRow(1);
        });

        if (btnDuplicateRow) btnDuplicateRow.addEventListener('click', () => {
          if (window.tableEditor) window.tableEditor.duplicateRows();
        });

        if (btnDeleteRow) btnDeleteRow.addEventListener('click', () => {
          if (window.tableEditor) window.tableEditor.deleteRows();
        });

        if (btnClearTable) btnClearTable.addEventListener('click', () => {
          if (window.tableEditor) window.tableEditor.clearAll();
        });

        if (btnImportCsv && importCsvInput) {
          btnImportCsv.addEventListener('click', () => {
            importCsvInput.click();
          });

          importCsvInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
              const rowCount = await CSVUtils.importCSVToTable(file, tableEditor);
              alert(`æˆåŠŸå¯¼å…¥ ${rowCount} è¡Œæ•°æ®`);
            } catch (error) {
              alert('å¯¼å…¥å¤±è´¥: ' + error.message);
            }

            importCsvInput.value = '';
          });
        }

        if (btnExportCsv) btnExportCsv.addEventListener('click', () => {
          if (tableEditor) {
            const timestamp = new Date().toISOString().slice(0, 10);
            CSVUtils.exportTableToCSV(tableEditor, `selection_data_${timestamp}.csv`);
          }
        });

        // ç»‘å®š CSV ä¸Šä¼ åŒºåŸŸ
        const csvUploadArea = document.getElementById('csv-upload-area');
        const csvFileInput = document.getElementById('csv-file-input');

        if (csvUploadArea && csvFileInput) {
          csvFileInput.addEventListener('change', function() {
            const placeholder = csvUploadArea.querySelector('.upload-placeholder');
            const selected = csvUploadArea.querySelector('.file-selected');
            const fileName = csvUploadArea.querySelector('.csv-file-name');
            const fileSize = csvUploadArea.querySelector('.csv-file-size');

            if (this.files && this.files[0]) {
              const file = this.files[0];
              if (placeholder) placeholder.classList.add('hidden');
              if (selected) selected.classList.remove('hidden');
              if (fileName) fileName.textContent = file.name;
              if (fileSize) fileSize.textContent = formatFileSize(file.size);
              csvUploadArea.classList.remove('border-gray-300', 'bg-gray-50');
              csvUploadArea.classList.add('border-green-400', 'bg-green-50');
            } else {
              if (placeholder) placeholder.classList.remove('hidden');
              if (selected) selected.classList.add('hidden');
              csvUploadArea.classList.add('border-gray-300', 'bg-gray-50');
              csvUploadArea.classList.remove('border-green-400', 'bg-green-50');
            }
          });
        }

        // ç»‘å®šè¡¨å•æäº¤
        bindFormSubmit();
      }

      // ========================================
      // ä¿®æ”¹è¡¨å•æäº¤é€»è¾‘
      // ========================================
      function bindFormSubmit() {
        const formEl = document.getElementById("control-form");
        if (!formEl) return;

        formEl.addEventListener("submit", async (event) => {
          event.preventDefault();
          event.stopImmediatePropagation();

          const formErrorEl = document.getElementById("form-error");
          const formErrorTextEl = document.getElementById("form-error-text");
          const runBtnEl = document.getElementById("run-btn");
          const logBoxEl = document.getElementById("log-box");

          if (formErrorEl) formErrorEl.classList.add("hidden");

          // æ£€æŸ¥è¾“å…¥æ¨¡å¼
          if (currentInputMode === 'table') {
            // è¡¨æ ¼æ¨¡å¼ï¼šéªŒè¯å¹¶æäº¤ JSON æ•°æ®
            if (!tableEditor) {
              alert('è¡¨æ ¼ç¼–è¾‘å™¨æœªåˆå§‹åŒ–');
              return;
            }

            const tableData = window.tableEditor.getData();
            if (tableData.length === 0) {
              alert('è¯·è‡³å°‘è¾“å…¥ä¸€è¡Œé€‰å“æ•°æ®');
              return;
            }

            const validation = window.tableEditor.validate();
            if (!validation.valid) {
              const errorMsg = validation.errors.map(e => `ç¬¬${e.row}è¡Œ: ${e.message}`).join('\n');
              alert('æ•°æ®éªŒè¯å¤±è´¥:\n' + errorMsg);
              return;
            }

            if (runBtnEl) {
              runBtnEl.setAttribute("aria-busy", "true");
              runBtnEl.disabled = true;
              runBtnEl.classList.add("opacity-75", "cursor-wait");
            }

            if (typeof usesDefaultMiaoshouAccount === 'function' && usesDefaultMiaoshouAccount()) {
              alert('æ£€æµ‹åˆ°å¦™æ‰‹è´¦å·æˆ–å¯†ç ä»ä¸ºé»˜è®¤å€¼ testerï¼Œè¯·åœ¨ã€Œç³»ç»Ÿè®¾ç½®ã€ä¸­ä¿®æ”¹åå†è¿è¡Œã€‚');
              if (runBtnEl) {
                runBtnEl.removeAttribute("aria-busy");
                runBtnEl.disabled = false;
                runBtnEl.classList.remove("opacity-75", "cursor-wait");
              }
              return;
            }

            try {
              // æ”¶é›†å…¶ä»–è¡¨å•å­—æ®µ
              const formData = new FormData(formEl);
              const otherFields = {};
              formData.forEach((value, key) => {
                if (key !== 'selection_file') {
                  otherFields[key] = value;
                }
              });

              // æäº¤ JSON æ•°æ®åˆ°ä¸“ç”¨æ¥å£
              const response = await fetch("/api/run-json", {
                method: "POST",
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  selection_data: tableData,
                  ...otherFields,
                }),
              });

              if (!response.ok) {
                const payload = await response.json();
                throw new Error(payload.detail || "æäº¤å¤±è´¥, è¯·é‡è¯•");
              }

              logCursor = -1;
              if (logBoxEl) logBoxEl.innerHTML = "";
              if (typeof refreshStatus === 'function') await refreshStatus();
              if (typeof refreshLogs === 'function') await refreshLogs();

              // æäº¤æˆåŠŸåæ¸…é™¤è‰ç¨¿
              window.tableEditor.clearDraft();

            } catch (error) {
              if (formErrorTextEl) formErrorTextEl.textContent = error.message;
              if (formErrorEl) formErrorEl.classList.remove("hidden");
            } finally {
              if (runBtnEl) {
                runBtnEl.removeAttribute("aria-busy");
                runBtnEl.disabled = false;
                runBtnEl.classList.remove("opacity-75", "cursor-wait");
              }
            }

          } else {
            // CSV æ¨¡å¼ï¼šä½¿ç”¨åŸæœ‰çš„æ–‡ä»¶ä¸Šä¼ é€»è¾‘
            const csvFileInputEl = document.getElementById('csv-file-input');
            const selectionFileInput = document.querySelector('input[name="selection_file"]');

            // å°† CSV ä¸Šä¼ åŒºçš„æ–‡ä»¶å¤åˆ¶åˆ°åŸæœ‰çš„ selection_file å­—æ®µ
            if (csvFileInputEl && csvFileInputEl.files.length > 0 && selectionFileInput) {
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(csvFileInputEl.files[0]);
              selectionFileInput.files = dataTransfer.files;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
            if (!selectionFileInput || !selectionFileInput.files.length) {
              alert('è¯·ä¸Šä¼ é€‰å“è¡¨æ–‡ä»¶');
              return;
            }

            const data = new FormData(formEl);
            if (!data.has("single_run")) {
              data.append("single_run", "off");
            }

            if (runBtnEl) {
              runBtnEl.setAttribute("aria-busy", "true");
              runBtnEl.disabled = true;
              runBtnEl.classList.add("opacity-75", "cursor-wait");
            }

            if (typeof usesDefaultMiaoshouAccount === 'function' && usesDefaultMiaoshouAccount()) {
              alert('æ£€æµ‹åˆ°å¦™æ‰‹è´¦å·æˆ–å¯†ç ä»ä¸ºé»˜è®¤å€¼ testerï¼Œè¯·åœ¨ã€Œç³»ç»Ÿè®¾ç½®ã€ä¸­ä¿®æ”¹åå†è¿è¡Œã€‚');
              if (runBtnEl) {
                runBtnEl.removeAttribute("aria-busy");
                runBtnEl.disabled = false;
                runBtnEl.classList.remove("opacity-75", "cursor-wait");
              }
              return;
            }

            try {
              const response = await fetch("/api/run", {
                method: "POST",
                body: data,
              });
              if (!response.ok) {
                const payload = await response.json();
                throw new Error(payload.detail || "æäº¤å¤±è´¥, è¯·é‡è¯•");
              }
              logCursor = -1;
              if (logBoxEl) logBoxEl.innerHTML = "";
              if (typeof refreshStatus === 'function') await refreshStatus();
              if (typeof refreshLogs === 'function') await refreshLogs();
            } catch (error) {
              if (formErrorTextEl) formErrorTextEl.textContent = error.message;
              if (formErrorEl) formErrorEl.classList.remove("hidden");
            } finally {
              if (runBtnEl) {
                runBtnEl.removeAttribute("aria-busy");
                runBtnEl.disabled = false;
                runBtnEl.classList.remove("opacity-75", "cursor-wait");
              }
            }
          }
        }, true); // ä½¿ç”¨æ•è·é˜¶æ®µæ‹¦æˆª
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', () => {
        initTableEditorAndBindings();
      });

      // å¦‚æœ DOM å·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³åˆå§‹åŒ–
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initTableEditorAndBindings();
      }
    </script>
  </body>
</html>
