# 调试模式使用指南

## 简介

调试模式（Debug Breakpoint Mode）提供类似调试器的断点功能，允许您逐步执行工作流，在每个关键步骤暂停并查看当前状态。

## 调试工具快速访问

- `src/browser/debug_tools.py` 新增 `capture_debug_artifacts`、`log_payload_preview`、`maybe_pause_for_inspector`，用于快速保存截图/HTML、在终端查看 payload 表格，并通过环境变量 `PLAYWRIGHT_DEBUG=1` 打开 Playwright Inspector。
- `run_with_optional_syncer()` 支持在安装 `syncer` 时将任意异步调试脚本同步执行，未安装时自动回退 `asyncio.run`。
- 示例脚本 `examples/first_edit_sync_debug.py` 展示了如何在同步模式下快速验证浏览器环境。
- 首次编辑弹窗由 `FirstEditExecutor` 管理，内置 `tenacity` 重试与自动调试快照，失败后会在 `data/debug/` 下生成截图和 DOM。
- 登录成功后 `LoginController` 会自动检测广告/活动弹窗并尝试关闭，导航至采集箱时 `MiaoshouController.close_popup_if_exists()` 也会做额外兜底，减少人工干预。

## 启用方式

### 方法1：命令行参数（推荐）

```bash
cd apps/temu-auto-publish

# 启用断点调试模式
python3 run_collection_to_edit_test.py --skip-collection --debug-breakpoint

# 或组合使用详细日志
python3 run_collection_to_edit_test.py --skip-collection --debug --debug-breakpoint
```

### 方法2：代码中启用

```python
from src.workflows.five_to_twenty_workflow import FiveToTwentyWorkflow

# 创建工作流时启用debug_mode
workflow = FiveToTwentyWorkflow(
    use_ai_titles=True,
    debug_mode=True  # 启用断点调试
)
```

## 使用说明

### 断点操作

当脚本运行到断点时，会显示类似以下的界面：

```
================================================================================
🔴 [调试断点 #1] 准备编辑第1个产品
📊 当前数据:
   产品索引: 0
   关键词: 产品1
   型号: AUTO001
   成本: 150.0
================================================================================
💡 操作提示:
   n  + Enter → 继续下一步 (Next)
   c  + Enter → 跳过所有断点继续运行 (Continue)
   q  + Enter → 退出程序 (Quit)
================================================================================
👉 请输入命令 (n/c/q): 
```

### 可用命令

| 命令 | 说明 | 用途 |
|------|------|------|
| `n` 或 Enter | 继续下一步 | 逐步执行，观察每个步骤 |
| `c` | 跳过所有断点 | 发现问题已解决，快速完成剩余流程 |
| `q` | 退出程序 | 发现严重问题，立即停止 |

## 断点位置

### 首次编辑流程（FiveToTwentyWorkflow）

脚本在以下关键位置设置了断点：

1. **准备编辑产品** - 开始编辑前，显示产品基本信息
2. **编辑弹窗已打开** - 确认弹窗正确打开
3. **准备调用AI生成标题** - AI调用前，显示原始标题和型号
4. **AI标题生成完成** - 显示AI生成结果和耗时
5. **准备保存** - 保存前，显示所有编辑内容（标题、价格、库存）

### 数据查看

每个断点都会显示当前步骤的关键数据，例如：

```
📊 当前数据:
   原始标题: 便携折叠露营床 双人沙滩日光浴椅...
   新标题: 便携折叠露营床 双人沙滩椅 4档调节 轻便坚固...
   耗时: 2.02秒
```

## 使用场景

### 场景1：调试选择器问题

```bash
# 逐步执行，观察每个字段的填写情况
python3 run_collection_to_edit_test.py --skip-collection --debug-breakpoint

# 在"准备保存"断点时，手动检查页面上的值是否正确
```

### 场景2：观察AI生成效果

```bash
# 启用断点，在AI生成后暂停查看效果
python3 run_collection_to_edit_test.py --skip-collection --debug-breakpoint

# 在"AI标题生成完成"断点时，评估生成质量
```

### 场景3：快速跳过已验证步骤

```bash
# 启动调试模式
python3 run_collection_to_edit_test.py --skip-collection --debug-breakpoint

# 第1个产品：逐步执行（输入 n）
# 第1个产品完成后：输入 c 跳过剩余4个产品的断点
```

## 与常规调试模式的区别

| 特性 | `--debug` | `--debug-breakpoint` |
|------|-----------|----------------------|
| 详细日志 | ✅ | ✅（自动启用） |
| 逐步执行 | ❌ | ✅ |
| 数据展示 | 仅日志 | 断点数据表格 |
| 用户交互 | ❌ | ✅（n/c/q命令） |
| 适用场景 | 快速查看日志 | 深度调试、学习流程 |

## 注意事项

1. **不要在生产环境使用** - 断点调试会暂停执行，仅用于开发和测试
2. **超时问题** - 某些操作有超时限制，暂停太久可能导致页面超时
3. **首次使用建议** - 先完整执行一遍（不断点），了解流程后再使用断点调试
4. **组合使用** - 建议与`--debug`一起使用以获得更详细的信息

## 常见问题

### Q: 如何只在特定产品启用断点？

A: 先按`c`跳过前面的产品，到达目标产品后再使用`n`逐步执行。

### Q: 断点太多，如何减少？

A: 可以手动编辑`five_to_twenty_workflow.py`，注释掉不需要的`await self.debug.breakpoint(...)`调用。

### Q: 忘记输入命令会怎样？

A: 脚本会一直等待输入，不会自动继续。某些操作可能因超时而失败。

## 示例会话

```bash
$ python3 run_collection_to_edit_test.py --skip-collection --debug-breakpoint

================================================================================
🔴 [调试断点 #1] 准备编辑第1个产品
📊 当前数据:
   产品索引: 0
   关键词: 产品1
   型号: AUTO001
   成本: 150.0
================================================================================
👉 请输入命令 (n/c/q): n  ← 继续
▶️  继续执行...

================================================================================
🔴 [调试断点 #2] 编辑弹窗已打开（第1个产品）
================================================================================
👉 请输入命令 (n/c/q): n  ← 继续

================================================================================
🔴 [调试断点 #3] 准备调用AI生成标题
📊 当前数据:
   原始标题: 便携折叠露营床 双人沙滩日光浴椅...
   型号: AUTO001
   AI启用: True
================================================================================
👉 请输入命令 (n/c/q): n  ← 继续

[AI调用中...]

================================================================================
🔴 [调试断点 #4] AI标题生成完成
📊 当前数据:
   原始标题: 便携折叠露营床 双人沙滩日光浴椅...
   新标题: 便携折叠露营床 双人沙滩椅 4档调节...
   耗时: 2.02秒
================================================================================
👉 请输入命令 (n/c/q): n  ← 继续

================================================================================
🔴 [调试断点 #5] 所有编辑完成，准备保存（第1个产品）
📊 当前数据:
   标题: 便携折叠露营床 双人沙滩椅 4档调节...
   价格: 1275.0
   库存: 100
================================================================================
👉 请输入命令 (n/c/q): c  ← 跳过剩余所有断点
⏩ 已启用自动继续模式，将跳过剩余所有断点

✓ 第1个产品首次编辑完成
✓ 第2个产品首次编辑完成  ← 自动跳过了断点
✓ 第3个产品首次编辑完成
...
```

## 高级用法

### 自定义断点

您可以在代码中添加自己的断点：

```python
# 在任何async函数中
await self.debug.breakpoint(
    "自定义检查点",
    data={
        "变量1": value1,
        "变量2": value2,
    }
)
```

### 条件断点

```python
# 只在特定条件下暂停
if product_index == 2:  # 只调试第3个产品
    await self.debug.breakpoint("第3个产品特殊检查")
```

## 相关文件

- `src/utils/debug_helper.py` - 调试辅助工具核心实现
- `src/workflows/five_to_twenty_workflow.py` - 包含断点的工作流
- `run_collection_to_edit_test.py` - 支持`--debug-breakpoint`参数的测试脚本

