# 选品表格式化工具

## 功能说明

将复杂的原始选品表Excel文件转换为脚本可以使用的标准格式。

## 原始格式 vs 标准格式

### 原始格式（10月品 .xlsx）
```
| 到货情况     | 产品名称         | 标题后缀   | 产品颜色/规格     |
|-------------|-----------------|-----------|------------------|
| 仓库现货可上架 | 卫生间收纳柜      | A026      | 规格一：3层       |
|             |                 |           | 规格二：4层       |
|             |                 |           | 规格三：5层       |
| 仓库现货可上架 | 带轮子的滚动洗衣篮 | A045/A046 | 规格一：中号      |
|             |                 |           | 规格一：大号      |
```

**问题**：
- 一个产品占多行（产品名称只在第一行）
- 规格分散在多行
- 无法直接被脚本读取

### 标准格式（转换后）
```
| 主品负责人 | 产品名称         | 标题后缀   | 产品颜色/规格     | 采集数量 | 实拍图数组            | 尺寸图链接 |
|----------|-----------------|-----------|------------------|---------|----------------------|------------|
|          | 卫生间收纳柜      | A026      | 规格一：3层       | 5       | ["A026.jpg"]         | https://oss.example.com/A026.jpg |
|          | 卫生间收纳柜      | A026      | 规格二：4层       | 5       | ["A026.jpg"]         | *(可留空，自动拼接)* |
|          | 卫生间收纳柜      | A026      | 规格三：5层       | 5       | ["A026.jpg"]         | *(可留空，自动拼接)* |
|          | 带轮子的滚动洗衣篮 | A045/A046 | 规格一：中号      | 5       | ["A045.jpg","A046.png"] | https://oss.example.com/A045.jpg |
|          | 带轮子的滚动洗衣篮 | A045/A046 | 规格一：大号      | 5       | ["A045.jpg","A046.png"] | https://oss.example.com/A046.png |
```

**特点**：
- 每行一个规格
- 产品名称和标题后缀向下填充
- 添加采集数量列（默认5）
- 添加主品负责人列（可手动填写）
- 可选列 `实拍图数组` 配合 `尺寸图链接` 提供尺寸图外链；若 `尺寸图链接` 留空，脚本会使用 `SIZE_CHART_BASE_URL` 与图片文件名自动拼接。

## 使用方法

### 1. 基本用法

```bash
cd /Users/candy/beimeng_workspace/apps/temu-auto-publish

# 格式化Excel文件
python scripts/format_selection_table.py "../../10月品 .xlsx"
```

**输出**：
- 文件位置：`data/input/10月品_formatted.xlsx`
- 格式：标准选品表格式

### 2. 指定输出文件名

```bash
python scripts/format_selection_table.py "../../10月品 .xlsx" -o my_products.xlsx
```

### 3. 仅预览不保存

```bash
python scripts/format_selection_table.py "../../10月品 .xlsx" --preview-only
```

### 4. 自定义预览行数

```bash
python scripts/format_selection_table.py "../../10月品 .xlsx" --preview-only --preview-lines 20
```

## 转换结果

### 统计信息
- ✅ **总行数**: 45
- ✅ **产品数**: 31
- ✅ **规格数**: 45

### 产品示例（前10个）
1. 卫生间收纳柜 (3个规格)
2. 带轮子的滚动洗衣篮 (2个规格)
3. 三层晾衣架(单管） (1个规格)
4. 马桶刷 黑色 (4个规格)
5. 15cm（大号）方形猫砂盆 (2个规格)
6. 注水式提壶哑铃 (1个规格)
7. 太空人垃圾桶 (1个规格)
8. 车载储物箱 (1个规格)
9. 车载储水箱 (1个规格)
10. 户外便携式帐篷 (2个规格)

## 配合脚本使用

### 简化模式（推荐）

```bash
# 手动在妙手采集箱中采集商品后，运行编辑脚本
python run_collection_to_edit_test.py \
    --skip-collection \
    --selection data/input/10月品_formatted.xlsx
```

**工作流程**：
1. ✅ 使用格式化工具转换Excel → `10月品_formatted.xlsx`
2. ✅ 手动在Temu前端采集商品到妙手采集箱
3. ✅ 运行脚本，直接从采集箱读取并编辑

### 完整模式（实验性）

```bash
# 从Excel读取 → 自动采集 → 编辑
python run_collection_to_edit_test.py \
    --selection data/input/10月品_formatted.xlsx
```

**注意**：完整模式需要处理Temu的反爬虫机制，目前建议使用简化模式。

## 使用断点调试模式

如果需要逐步观察脚本运行：

```bash
python run_collection_to_edit_test.py \
    --skip-collection \
    --selection data/input/10月品_formatted.xlsx \
    --debug-breakpoint
```

在每个关键步骤：
- 按 **`n`** + Enter → 继续下一步
- 按 **`c`** + Enter → 跳过所有断点
- 按 **`q`** + Enter → 退出

## 数据验证

格式化工具会自动验证：

✅ **必填列检查**
- 主品负责人
- 产品名称
- 标题后缀
- 产品颜色/规格
- 采集数量

✅ **空值检查**
- 产品名称不能为空
- 标题后缀不能为空
- 规格不能为空

✅ **采集数量检查**
- 必须在1-100范围内

## 常见问题

### Q: 转换后"主品负责人"列为空？

A: 这是正常的，需要手动在Excel中填写负责人名称。或者忽略此列，脚本会使用默认值。

### Q: 为什么采集数量都是5？

A: 这是默认值。您可以在转换后的Excel中修改为需要的数量（1-100之间）。

### Q: 如何处理多个型号的产品？

A: 
- 如果标题后缀是 `A045/A046`，会被保留
- 脚本会使用完整的型号字符串（包含斜杠）

### Q: 原始Excel中的图片和价格信息会保留吗？

A: 不会。格式化工具只提取以下信息：
- 产品名称
- 标题后缀
- 产品颜色/规格

其他信息（图片、价格等）需要在脚本运行时通过其他方式获取或设置。

## 文件位置

```
apps/temu-auto-publish/
├── scripts/
│   └── format_selection_table.py    # 格式化工具
├── data/
│   └── input/
│       ├── 10月品_formatted.xlsx    # 格式化后的文件（已生成）
│       └── selection.xlsx            # 示例文件
└── docs/
    └── SELECTION_FORMAT.md          # 本文档
```

## 技术细节

### 转换逻辑

1. **读取原始Excel**
   - 读取所有行和列
   - 识别关键列（产品名称、标题后缀、规格等）

2. **向下填充**
   - 产品名称向下填充（填充到下一个非空产品名称之前）
   - 标题后缀向下填充

3. **过滤和清理**
   - 删除无规格信息的行
   - 删除产品名称或标题后缀为空的行

4. **添加默认值**
   - 采集数量：5
   - 主品负责人：空（需手动填写）

5. **重新排列列**
   - 调整为标准格式的列顺序

### 依赖

- `pandas`: Excel读写
- `openpyxl`: Excel格式支持
- `loguru`: 日志输出

## 下一步

1. ✅ 使用格式化工具生成标准Excel
2. ✅ （可选）在Excel中填写"主品负责人"列
3. ✅ （可选）调整"采集数量"
4. ✅ 在Temu前端手动采集商品到妙手采集箱
5. ✅ 运行编辑脚本：
   ```bash
   python run_collection_to_edit_test.py \
       --skip-collection \
       --selection data/input/10月品_formatted.xlsx
   ```

## 相关文档

- [调试模式使用指南](DEBUG_MODE.md)
- [项目README](../README.md)
- [快速开始](../QUICKSTART.md)

